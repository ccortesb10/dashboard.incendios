<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Contador de Alarmas 2026</title>

<!-- Chart.js (CDN oficial) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root { --rojo:#d32f2f; --rojo2:#b71c1c; --gris:#f2f2f2; }
  body { font-family: system-ui, Arial; padding: 16px; background: var(--gris); }
  .card { background: #fff; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
  h1,h2 { margin: 0 0 12px 0; }
  label { display:block; margin:8px 0 4px; font-weight:600; }
  input, select {
    width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px;
  }
  .row { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  button {
    width:100%; padding:12px; background:var(--rojo); color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer;
  }
  button:hover { background: var(--rojo2); }
  table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
  th, td { border:1px solid #e6e6e6; padding:8px; text-align:center; }
  th { background:#fafafa; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; }
  .muted { color:#666; font-size:13px; }
  .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eee; margin-right:6px; }
</style>
</head>
<body>

<div class="card">
  <h1>Contador de Alarmas 2026 üî•</h1>
  <div class="muted">
    Guarda localmente en tu dispositivo. Puedes exportar a CSV y publicar esta app en GitHub Pages.
  </div>
</div>

<div class="card">
  <h2>Ingresar Alarma</h2>
  <div class="row">
    <div>
      <label for="fecha">Fecha del Incendio</label>
      <input type="date" id="fecha" />
    </div>
    <div>
      <label for="hora">Hora del Incendio</label>
      <input type="time" id="hora" />
    </div>
    <div>
      <label for="obac">OBAC</label>
      <input type="text" id="obac" placeholder="Ej: OBAC 1" />
    </div>
    <div>
      <label for="alarma">Alarma de Incendio</label>
      <select id="alarma">
        <option value="1¬∞ Alarma">1¬∞ Alarma</option>
        <option value="2¬∞ Alarma">2¬∞ Alarma</option>
        <option value="3¬∞ Alarma">3¬∞ Alarma</option>
        <option value="4¬∞ Alarma">4¬∞ Alarma</option>
      </select>
    </div>
    <div>
      <label for="unidad">Unidad / Compa√±√≠a</label>
      <input type="text" id="unidad" placeholder="Ej: 22-01, 6-01, 45, Vol 7¬∞, etc." />
    </div>
  </div>

  <div style="margin-top:12px" class="actions">
    <button id="btnGuardar">üìå Guardar Registro</button>
    <button id="btnExportar" style="background:#455a64">üì• Exportar a CSV</button>
    <button id="btnBorrarTodo" style="background:#6d4c41">üóëÔ∏è Borrar todo (local)</button>
  </div>
  <div class="muted" style="margin-top:8px">
    * Los datos se guardan en este navegador (LocalStorage). Si borras el historial o cambias de navegador/dispositivo, no se comparten autom√°ticamente.
  </div>
</div>

<div class="card">
  <h2>Registros Guardados</h2>
  <div id="resumen" class="muted"></div>
  <table id="tabla">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Hora</th>
        <th>OBAC</th>
        <th>Alarma</th>
        <th>Unidad</th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h2>Gr√°fico por Unidad</h2>
  <canvas id="grafUnidad" height="160"></canvas>
</div>

<div class="card">
  <h2>Gr√°fico por Tipo de Alarma</h2>
  <canvas id="grafAlarma" height="160"></canvas>
</div>

<div class="card">
  <h2>Gr√°fico por Mes</h2>
  <div class="muted">Formato AAAA-MM</div>
  <canvas id="grafMes" height="160"></canvas>
</div>

<script>
/* ------------------ Utilidades de almacenamiento ------------------ */
const KEY = "alarmas_2026";

function cargar() {
  try { return JSON.parse(localStorage.getItem(KEY)) || []; }
  catch { return []; }
}
function guardar(arr) {
  localStorage.setItem(KEY, JSON.stringify(arr));
}

/* ------------------ UI: tabla, resumen, gr√°ficos ------------------ */
function renderTabla() {
  const datos = cargar();
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  datos.forEach((d, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.fecha}</td>
      <td>${d.hora}</td>
      <td>${d.obac}</td>
      <td>${d.alarma}</td>
      <td>${d.unidad}</td>
      <td><button style="background:#9e9e9e;padding:6px 10px;border-radius:6px" onclick="eliminar(${i})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Resumen (total del mes actual y total general)
  const total = datos.length;
  const hoy = new Date();
  const ym = hoy.toISOString().slice(0,7); // AAAA-MM
  const delMes = datos.filter(d => (d.fecha || "").startsWith(ym)).length;
  document.getElementById("resumen").innerHTML =
    `<span class="pill">Total ${ym}: <b>${delMes}</b></span>
     <span class="pill">Total acumulado 2026: <b>${total}</b></span>`;
}

let chartUnidad, chartAlarma, chartMes;

function agruparPor(arr, selector) {
  const m = new Map();
  arr.forEach(x => {
    const k = selector(x);
    if (!k) return;
    m.set(k, (m.get(k) || 0) + 1);
  });
  return { etiquetas: [...m.keys()], valores: [...m.values()] };
}

function actualizarGraficos() {
  const datos = cargar();

  // Por Unidad
  const gUnidad = agruparPor(datos, d => (d.unidad || "").trim());
  chartUnidad && chartUnidad.destroy();
  chartUnidad = new Chart(document.getElementById("grafUnidad"), {
    type: "bar",
    data: {
      labels: gUnidad.etiquetas,
      datasets: [{
        label: "Alarmas por Unidad",
        data: gUnidad.valores,
        backgroundColor: "#d32f2f"
      }]
    },
    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, precision:0}} }
  });

  // Por Tipo de Alarma
  const gAlarma = agruparPor(datos, d => d.alarma);
  chartAlarma && chartAlarma.destroy();
  chartAlarma = new Chart(document.getElementById("grafAlarma"), {
    type: "pie",
    data: {
      labels: gAlarma.etiquetas,
      datasets: [{ data: gAlarma.valores, backgroundColor: ["#b71c1c","#e57373","#ff8a80","#ffcdd2"] }]
    }
  });

  // Por Mes (AAAA-MM)
  const gMes = agruparPor(datos, d => (d.fecha || "").slice(0,7));
  const pares = gMes.etiquetas.map((k,i) => [k, gMes.valores[i]]).sort((a,b) => a[0].localeCompare(b[0]));
  chartMes && chartMes.destroy();
  chartMes = new Chart(document.getElementById("grafMes"), {
    type: "line",
    data: {
      labels: pares.map(p => p[0]),
      datasets: [{
        label: "Alarmas por Mes",
        data: pares.map(p => p[1]),
        borderColor: "#b71c1c",
        backgroundColor: "rgba(183,28,28,.15)",
        tension: .2,
        fill: true
      }]
    },
    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, precision:0}} }
  });
}

/* ------------------ Acciones ------------------ */
function limpiarFormulario() {
  ["fecha","hora","obac","unidad"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("alarma").value = "1¬∞ Alarma";
}
function validarCampos() {
  const fecha = document.getElementById("fecha").value;
  const hora  = document.getElementById("hora").value;
  const obac  = document.getElementById("obac").value.trim();
  const alarma= document.getElementById("alarma").value;
  const unidad= document.getElementById("unidad").value.trim();
  if (!fecha || !hora || !obac || !unidad) return null;
  return { fecha, hora, obac, alarma, unidad };
}

function guardarRegistro() {
  const reg = validarCampos();
  if (!reg) { alert("Completa todos los campos."); return; }
  const arr = cargar();
  arr.push(reg);
  guardar(arr);
  renderTabla();
  actualizarGraficos();
  limpiarFormulario();
}

function exportarCSV() {
  const arr = cargar();
  let csv = "Fecha,Hora,OBAC,Alarma,Unidad\n";
  arr.forEach(d => csv += `${d.fecha},${d.hora},${d.obac},${d.alarma},${d.unidad}\n`);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "alarmas_2026.csv";
  a.click();
}

function eliminar(idx) {
  const arr = cargar();
  arr.splice(idx, 1);
  guardar(arr);
  renderTabla();
  actualizarGraficos();
}

function borrarTodo() {
  if (!confirm("Esto borrar√° todos los registros guardados localmente en este navegador. ¬øContinuar?")) return;
  localStorage.removeItem(KEY);
  renderTabla();
  actualizarGraficos();
}

/* ------------------ Eventos ------------------ */
document.getElementById("btnGuardar").addEventListener("click", guardarRegistro);
document.getElementById("btnExportar").addEventListener("click", exportarCSV);
document.getElementById("btnBorrarTodo").addEventListener("click", borrarTodo);

/* ------------------ Precarga opcional de tus contadores ------------------ */
/*  Si quieres iniciar con algunos valores (por ejemplo los totales que pasaste),
    descomenta este bloque UNA sola vez, recarga, y luego vuelve a comentarlo.
*/
// (function precarga() {
//   if ((cargar()||[]).length) return; // ya hay datos
//   const seed = [
//     {unidad:"22-01", n:8}, {unidad:"6-01", n:6}, {"unidad":"4¬∞ Comandante", n:2},
//     {"unidad":"45", n:2}, {"unidad":"Vol 7¬∞ Manuel P√©rez", n:2}, {"unidad":"8-03", n:1},
//     {"unidad":"Vol 8¬∞ Manuel Cerpa", n:2}, {"unidad":"21-03", n:2}, {"unidad":"51", n:1},
//     {"unidad":"3-03", n:1}, {"unidad":"8-02", n:1}, {"unidad":"10-03", n:1},
//     {"unidad":"17-03", n:1}, {"unidad":"18¬∞ Guillermo Chinni", n:1}
//   ];
//   const arr = []; // ejemplo con fechas en enero y febrero 2026
//   seed.forEach(s => {
//     for (let i=0;i<s.n;i++) {
//       const mes = (i % 2 === 0) ? "2026-01-01" : "2026-02-01";
//       arr.push({fecha: mes, hora: "12:00", obac: "OBAC 1", alarma: "1¬∞ Alarma", unidad: s.unidad});
//     }
//   });
//   guardar(arr);
// })();

/* ------------------ Inicializaci√≥n ------------------ */
renderTabla();
actualizarGraficos();
</script>
</body>
</html>
