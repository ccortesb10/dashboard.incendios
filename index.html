<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Contador de Alarmas 2026</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  :root { --bg:#f4f5f7; --card:#ffffff; --text:#111827; --muted:#4b5563; --border:#e5e7eb; --primary:#ef4444; --primary-2:#dc2626; --secondary:#334155; --warn:#8b5e34; --gray:#6b7280; --chip:#f3f4f6; --chart-grid:rgba(0,0,0,.08); --chart-ticks:#374151; --chart-legend:#111827; }
  :root[data-theme="dark"] { --bg:#0f1216; --card:#171a1f; --text:#e5e7eb; --muted:#9aa4b2; --border:#242a32; --primary:#ef4444; --primary-2:#dc2626; --secondary:#334155; --warn:#8b5e34; --gray:#6b7280; --chip:#1f2733; --chart-grid:rgba(148,163,184,.15); --chart-ticks:#cbd5e1; --chart-legend:#e5e7eb; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:12px;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:0 auto}
  .card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 1px 8px rgba(0,0,0,.15)}
  h1,h2,h3{margin:0 0 10px 0;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:var(--chip);color:var(--muted);margin-right:6px;font-size:12px;border:1px solid var(--border)}
  .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .theme-toggle{display:flex;align-items:center;gap:8px}
  .switch{position:relative;display:inline-block;width:48px;height:26px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;inset:0;cursor:pointer;border:1px solid var(--border);background:#64748b;transition:.2s;border-radius:999px}
  .slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;top:2px;background:#fff;transition:.2s;border-radius:50%}
  input:checked + .slider{background:#ef4444}
  input:checked + .slider:before{transform:translateX(22px)}
  .theme-label{font-size:13px;color:var(--muted)}
  details{border-radius:8px}
  summary{list-style:none;cursor:pointer;font-weight:700;padding:8px 10px;border-radius:8px;display:flex;align-items:center;gap:8px;color:var(--text)}
  summary::marker{display:none}
  summary .badge{background:rgba(239,68,68,.15);color:var(--primary);padding:2px 8px;border-radius:12px;font-size:12px;border: 1px solid var(--border)}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:8px}
  label{display:block;margin:4px 0 3px;font-weight:600;font-size:13px;color:var(--muted)}
  input,select{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#0b0e12;color:var(--text)}
  :root[data-theme="light"] input,:root[data-theme="light"] select{background:#fff;color:var(--text)}
  input::placeholder{color:#7a8699}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{padding:8px 10px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer}
  button:hover{background:var(--primary-2)}
  button.secondary{background:var(--secondary)}
  button.secondary:hover{background:#1f2a37}
  button.warn{background:var(--warn)}
  button.warn:hover{background:#734a2a}
  button.gray{background:var(--gray)}
  button.gray:hover{background:#4b5563}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  th,td{border:1px solid var(--border);padding:6px;text-align:center}
  th{background:#0b0f14;color:var(--muted)}
  :root[data-theme="light"] th{background:#f8fafc}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toolbar .grow{flex:1}

  /* Dos filas: 3 arriba, 3 abajo */
  .charts.top{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .charts.bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  @media (max-width: 1100px){ .charts.bottom{grid-template-columns:repeat(2,1fr)} }
  @media (max-width: 980px){ .charts.top{grid-template-columns:repeat(2,1fr)} }
  @media (max-width: 640px){ .charts.top,.charts.bottom{grid-template-columns:1fr} }

  .chart-card{padding:10px;border:1px solid var(--border);border-radius:8px;background:#0b0f14;height:200px}
  :root[data-theme="light"] .chart-card{background:#ffffff}
  .chart-card canvas{width:100% !important;height:100% !important;display:block}

  .direccion-group{display:flex;gap:6px;align-items:flex-end}
  .direccion-group>div{flex:1}
  dialog{border:none;border-radius:10px;width:min(420px,96vw);padding:16px;background:var(--card);color:var(--text);border:1px solid var(--border)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
</style>
</head>
<body>
<div class="container">

  <div class="card">
    <div class="header-row">
      <div>
        <h1>Contador de Alarmas 2026 ğŸ”¥</h1>
        <div class="muted">Registrar (plegado) â†’ Dashboard visible â†’ Registros (plegado). Tema claro/oscuro con switch.</div>
      </div>
      <div class="theme-toggle">
        <span class="theme-label">â˜€ï¸</span>
        <label class="switch" aria-label="Cambiar tema claro/oscuro">
          <input id="themeSwitch" type="checkbox" />
          <span class="slider"></span>
        </label>
        <span class="theme-label">ğŸŒ™</span>
        <button id="btnLogin" class="secondary" style="margin-left:10px;">Ingresar</button>
        <button id="btnLogout" class="gray" style="display:none;">Salir</button>
      </div>
    </div>
  </div>

  <div class="card" id="cardRegistrar" style="display:none">
    <details>
      <summary>â• Registrar alarma <span class="badge">compacto</span></summary>
      <div class="row">
        <div>
          <label for="fecha">Fecha del Incendio</label>
          <input type="date" id="fecha" required />
        </div>
        <div>
          <label for="hora">Hora del Incendio</label>
          <input type="time" id="hora" required />
        </div>
        <div>
          <label for="cargo">Cargo</label>
          <select id="cargo" required>
            <option value="Comandante 1">Comandante 1</option>
            <option value="Comandante 2">Comandante 2</option>
            <option value="Comandante 3">Comandante 3</option>
            <option value="Comandante 4">Comandante 4</option>
            <option value="CapitÃ¡n">CapitÃ¡n</option>
            <option value="Teniente 1Â°">Teniente 1Â°</option>
            <option value="Teniente 2Â°">Teniente 2Â°</option>
            <option value="Teniente 3Â°">Teniente 3Â°</option>
            <option value="Inspector">Inspector</option>
            <option value="Voluntario">Voluntario</option>
            <option value="Central">Central</option>
            <option value="Cuartelero">Cuartelero</option>
            <option value="Canje">Canje</option>
          </select>
        </div>
        <div>
          <label for="compania">CompaÃ±Ã­a</label>
          <select id="compania" required>
            <option value="1Â° CompaÃ±Ã­a">1Â° CompaÃ±Ã­a</option>
            <option value="2Â° CompaÃ±Ã­a">2Â° CompaÃ±Ã­a</option>
            <option value="3Â° CompaÃ±Ã­a">3Â° CompaÃ±Ã­a</option>
            <option value="4Â° CompaÃ±Ã­a">4Â° CompaÃ±Ã­a</option>
            <option value="5Â° CompaÃ±Ã­a">5Â° CompaÃ±Ã­a</option>
            <option value="6Â° CompaÃ±Ã­a">6Â° CompaÃ±Ã­a</option>
            <option value="7Â° CompaÃ±Ã­a">7Â° CompaÃ±Ã­a</option>
            <option value="8Â° CompaÃ±Ã­a">8Â° CompaÃ±Ã­a</option>
            <option value="9Â° CompaÃ±Ã­a">9Â° CompaÃ±Ã­a</option>
            <option value="10Â° CompaÃ±Ã­a">10Â° CompaÃ±Ã­a</option>
            <option value="11Â° CompaÃ±Ã­a">11Â° CompaÃ±Ã­a</option>
            <option value="12Â° CompaÃ±Ã­a">12Â° CompaÃ±Ã­a</option>
            <option value="13Â° CompaÃ±Ã­a">13Â° CompaÃ±Ã­a</option>
            <option value="14Â° CompaÃ±Ã­a">14Â° CompaÃ±Ã­a</option>
            <option value="15Â° CompaÃ±Ã­a">15Â° CompaÃ±Ã­a</option>
            <option value="16Â° CompaÃ±Ã­a">16Â° CompaÃ±Ã­a</option>
            <option value="17Â° CompaÃ±Ã­a">17Â° CompaÃ±Ã­a</option>
            <option value="18Â° CompaÃ±Ã­a">18Â° CompaÃ±Ã­a</option>
            <option value="19Â° CompaÃ±Ã­a">19Â° CompaÃ±Ã­a</option>
            <option value="20Â° CompaÃ±Ã­a">20Â° CompaÃ±Ã­a</option>
            <option value="21Â° CompaÃ±Ã­a">21Â° CompaÃ±Ã­a</option>
            <option value="22Â° CompaÃ±Ã­a">22Â° CompaÃ±Ã­a</option>
            <option value="Comandancia">Comandancia</option>
            <option value="Central">Central</option>
          </select>
        </div>
        <div>
          <label for="obac">OBAC</label>
          <input type="text" id="obac" placeholder="Ej: OBAC 1" required />
        </div>
        <div>
          <label for="alarma">Alarma de Incendio</label>
          <select id="alarma" required>
            <option value="PRIMERA ALARMA">PRIMERA ALARMA</option>
            <option value="SEGUNDA ALARMA">SEGUNDA ALARMA</option>
            <option value="TERCERA ALARMA">TERCERA ALARMA</option>
          </select>
        </div>
        <div>
          <label for="tipo">Tipo de Incendio</label>
          <select id="tipo" required>
            <option value="Estructural">Estructural</option>
            <option value="Forestal">Forestal</option>
          </select>
        </div>
        <div class="direccion-group" style="grid-column:1/-1;">
          <div>
            <label for="direccion">DirecciÃ³n (opcional)</label>
            <input type="text" id="direccion" placeholder="Ej: Av. Siempre Viva 742, Comuna" />
          </div>
          <div style="width:fit-content;">
            <button type="button" id="btnGeo" class="secondary" title="Usar ubicaciÃ³n actual">ğŸ“ Usar ubicaciÃ³n</button>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="btnGuardar">ğŸ“Œ Guardar</button>
        <button id="btnExportarCSV" class="secondary">ğŸ“¥ CSV</button>
        <button id="btnExportarJSON" class="secondary">ğŸ§© Exportar JSON</button>
        <label class="secondary" style="display:inline-flex;align-items:center;gap:8px;padding:0;">
          <input id="importJSON" type="file" accept="application/json" style="display:none;">
          <button type="button" class="secondary" id="btnImportarJSON">ğŸ“¤ Importar JSON</button>
        </label>
        <button id="btnBorrarTodo" class="warn">ğŸ—‘ï¸ Borrar todo</button>
        <button id="btnSyncNube" class="secondary">â˜ï¸ Sincronizar a nube</button>
      </div>
      <div class="muted" style="margin-top:6px">* Lectura pÃºblica. Registrar/editar/eliminar sÃ³lo usuarios autorizados (Email/Password).</div>
    </details>
  </div>

  <!-- Dashboard: 3 arriba, 3 abajo -->
  <div class="card">
    <h2>Dashboard</h2>

    <!-- BotÃ³n y opciÃ³n de filtros para ranking CompaÃ±Ã­a - OBAC -->
    <div class="toolbar" style="margin:8px 0 10px; gap:8px; align-items:center; display:flex; flex-wrap:wrap;">
      <div class="muted" style="margin-right:auto;">&nbsp;</div>
      <label class="muted" style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="rk2_usarFiltros" checked /> Usar filtros (Mes / BÃºsqueda)
      </label>
      <button id="btnRankingCompObac" class="secondary">ğŸ“‹ Copiar â€œCompaÃ±Ã­a - OBACâ€</button>
    </div>

    <div class="charts top">
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por CompaÃ±Ã­a</h3>
        <canvas id="grafCompania"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Alarma</h3>
        <canvas id="grafAlarma"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Cargo</h3>
        <canvas id="grafCargo"></canvas>
      </div>
    </div>
    <div class="charts bottom">
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Tipo</h3>
        <canvas id="grafTipo"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Mes (AAAAâ€‘MM)</h3>
        <canvas id="grafMes"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por OBAC</h3>
        <canvas id="grafObac"></canvas>
      </div>
    </div>
  </div>

  <div class="card">
    <details>
      <summary>ğŸ“„ Registros <span class="badge">tabla</span></summary>
      <div class="toolbar" style="margin-top:8px;">
        <h2 style="margin-right:auto;">&nbsp;</h2>
        <div>
          <label class="muted" for="filtroMes">Mes (AAAAâ€‘MM)</label>
          <input type="month" id="filtroMes" />
        </div>
        <div class="grow">
          <label class="muted" for="buscar">Buscar (Cargo / CompaÃ±Ã­a / OBAC / Alarma / Tipo / DirecciÃ³n)</label>
          <input type="text" id="buscar" placeholder="Buscar..." />
        </div>
      </div>
      <div id="resumen" class="muted" style="margin-top:6px"></div>
      <table id="tabla">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Cargo</th>
            <th>CompaÃ±Ã­a</th>
            <th>OBAC</th>
            <th>Alarma</th>
            <th>Tipo</th>
            <th>DirecciÃ³n</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </details>
  </div>

  <dialog id="dlgEditar">
    <form method="dialog">
      <h3>Editar registro</h3>
      <div class="row">
        <div>
          <label for="e_fecha">Fecha</label>
          <input type="date" id="e_fecha" required />
        </div>
        <div>
          <label for="e_hora">Hora</label>
          <input type="time" id="e_hora" required />
        </div>
        <div>
          <label for="e_cargo">Cargo</label>
          <select id="e_cargo" required>
            <option value="Comandante 1">Comandante 1</option>
            <option value="Comandante 2">Comandante 2</option>
            <option value="Comandante 3">Comandante 3</option>
            <option value="Comandante 4">Comandante 4</option>
            <option value="CapitÃ¡n">CapitÃ¡n</option>
            <option value="Teniente 1Â°">Teniente 1Â°</option>
            <option value="Teniente 2Â°">Teniente 2Â°</option>
            <option value="Teniente 3Â°">Teniente 3Â°</option>
            <option value="Inspector">Inspector</option>
            <option value="Voluntario">Voluntario</option>
            <option value="Central">Central</option>
            <option value="Cuartelero">Cuartelero</option>
            <option value="Canje">Canje</option>
          </select>
        </div>
        <div>
          <label for="e_compania">CompaÃ±Ã­a</label>
          <select id="e_compania" required>
            <option value="1Â° CompaÃ±Ã­a">1Â° CompaÃ±Ã­a</option>
            <option value="2Â° CompaÃ±Ã­a">2Â° CompaÃ±Ã­a</option>
            <option value="3Â° CompaÃ±Ã­a">3Â° CompaÃ±Ã­a</option>
            <option value="4Â° CompaÃ±Ã­a">4Â° CompaÃ±Ã­a</option>
            <option value="5Â° CompaÃ±Ã­a">5Â° CompaÃ±Ã­a</option>
            <option value="6Â° CompaÃ±Ã­a">6Â° CompaÃ±Ã­a</option>
            <option value="7Â° CompaÃ±Ã­a">7Â° CompaÃ±Ã­a</option>
            <option value="8Â° CompaÃ±Ã­a">8Â° CompaÃ±Ã­a</option>
            <option value="9Â° CompaÃ±Ã­a">9Â° CompaÃ±Ã­a</option>
            <option value="10Â° CompaÃ±Ã­a">10Â° CompaÃ±Ã­a</option>
            <option value="11Â° CompaÃ±Ã­a">11Â° CompaÃ±Ã­a</option>
            <option value="12Â° CompaÃ±Ã­a">12Â° CompaÃ±Ã­a</option>
            <option value="13Â° CompaÃ±Ã­a">13Â° CompaÃ±Ã­a</option>
            <option value="14Â° CompaÃ±Ã­a">14Â° CompaÃ±Ã­a</option>
            <option value="15Â° CompaÃ±Ã­a">15Â° CompaÃ±Ã­a</option>
            <option value="16Â° CompaÃ±Ã­a">16Â° CompaÃ±Ã­a</option>
            <option value="17Â° CompaÃ±Ã­a">17Â° CompaÃ±Ã­a</option>
            <option value="18Â° CompaÃ±Ã­a">18Â° CompaÃ±Ã­a</option>
            <option value="19Â° CompaÃ±Ã­a">19Â° CompaÃ±Ã­a</option>
            <option value="20Â° CompaÃ±Ã­a">20Â° CompaÃ±Ã­a</option>
            <option value="21Â° CompaÃ±Ã­a">21Â° CompaÃ±Ã­a</option>
            <option value="22Â° CompaÃ±Ã­a">22Â° CompaÃ±Ã­a</option>
            <option value="Comandancia">Comandancia</option>
            <option value="Central">Central</option>
          </select>
        </div>
        <div>
          <label for="e_obac">OBAC</label>
          <input type="text" id="e_obac" required />
        </div>
        <div>
          <label for="e_alarma">Alarma</label>
          <select id="e_alarma" required>
            <option value="PRIMERA ALARMA">PRIMERA ALARMA</option>
            <option value="SEGUNDA ALARMA">SEGUNDA ALARMA</option>
            <option value="TERCERA ALARMA">TERCERA ALARMA</option>
          </select>
        </div>
        <div>
          <label for="e_tipo">Tipo</label>
          <select id="e_tipo" required>
            <option value="Estructural">Estructural</option>
            <option value="Forestal">Forestal</option>
          </select>
        </div>
        <div style="grid-column:1/-1;">
          <label for="e_direccion">DirecciÃ³n</label>
          <input type="text" id="e_direccion" />
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button type="submit">ğŸ’¾ Guardar</button>
        <button type="button" class="gray" onclick="document.getElementById('dlgEditar').close()">Cancelar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlgLogin">
    <form id="formLogin" method="dialog">
      <h3>Ingresar</h3>
      <div class="row">
        <div style="grid-column:1/-1;">
          <label for="login_email">Correo</label>
          <input type="email" id="login_email" required placeholder="operador@central.cl" />
        </div>
        <div style="grid-column:1/-1;">
          <label for="login_pass">ContraseÃ±a</label>
          <input type="password" id="login_pass" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button type="submit">ğŸ”‘ Ingresar</button>
        <button type="button" class="gray" onclick="document.getElementById('dlgLogin').close()">Cancelar</button>
      </div>
      <div class="muted" style="margin-top:8px">* Cuentas creadas por el administrador en Firebase.</div>
    </form>
  </dialog>

</div>

<script>
// Firebase config (tu config real)
const firebaseConfig = {
  apiKey: "AIzaSyAHrcx9UK40TiW4BCFZOPHKj5XrJ_2OKBI",
  authDomain: "alarmas-2026.firebaseapp.com",
  projectId: "alarmas-2026",
  storageBucket: "alarmas-2026.firebasestorage.app",
  messagingSenderId: "522655513477",
  appId: "1:522655513477:web:816d4bb49aff6f798f62ec",
  measurementId: "G-5BLMH5VGHV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const COL = 'alarmas';
</script>

<script>
// THEME
const KEY_THEME = "alarmas_theme";
function setTheme(theme){ const t=(theme||"dark").toLowerCase()==="light"?"light":"dark"; document.documentElement.setAttribute("data-theme",t); const sw=document.getElementById("themeSwitch"); if(sw) sw.checked=(t==="dark"); try{actualizarGraficos()}catch(_){} }
window.addEventListener("DOMContentLoaded",()=>{ const saved=(localStorage.getItem(KEY_THEME)||(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?"dark":"light")); setTheme(saved); const sw=document.getElementById("themeSwitch"); if(sw){ sw.addEventListener("change",e=>{ const next=e.target.checked?"dark":"light"; localStorage.setItem(KEY_THEME,next); setTheme(next); }); }});

// STORAGE
const KEY = "alarmas_2026";
function cargar(){ let arr; try{arr=JSON.parse(localStorage.getItem(KEY))||[]}catch{arr=[]} let changed=false; arr.forEach(r=>{ if(!r.id){r.id=String(Date.now())+Math.random().toString(16).slice(2);changed=true} if(r.cargo===undefined){r.cargo="";changed=true} if(r.compania===undefined){r.compania="";changed=true} if(r.direccion===undefined){r.direccion="";changed=true} }); if(changed) localStorage.setItem(KEY,JSON.stringify(arr)); return arr; }
function guardar(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }

// UI HELPERS
let chartCompania, chartAlarma, chartCargo, chartTipo, chartMes, chartObac, editId=null;
const $=s=>document.querySelector(s);
function normaliza(s){return (s||"").trim()}
function ordenarDesc(arr){ return [...arr].sort((a,b)=>{ const A=(a.fecha||"")+" "+(a.hora||"00:00"); const B=(b.fecha||"")+" "+(b.hora||"00:00"); return B.localeCompare(A); }); }
function aplicaFiltros(arr){ const mes=$("#filtroMes")?.value||""; const q=($("#buscar")?.value||"").toLowerCase().trim(); return arr.filter(d=>{ const okMes=!mes||(d.fecha||"").startsWith(mes); const text=`${d.cargo} ${d.compania} ${d.obac} ${d.alarma} ${d.tipo} ${d.direccion}`.toLowerCase(); const okQ=!q||text.includes(q); return okMes&&okQ; }); }
function resumen(arr,mesSel){ const total=arr.length; const totalMes=mesSel?arr.filter(d=>(d.fecha||"").startsWith(mesSel)).length:total; return {total,totalMes}; }

// TABLA (acciones solo para isWriter)
function renderTabla(){ const datos=ordenarDesc(cargar()); const filtrados=aplicaFiltros(datos); const tbody=document.querySelector("#tabla tbody"); if(!tbody) return; tbody.innerHTML=""; filtrados.forEach(d=>{ const tr=document.createElement("tr"); const accionesTd = (window.isWriter)
  ? `<button class="gray" onclick="abrirEditar('${d.id}')">Editar</button> <button class="warn" onclick="eliminar('${d.id}')">Eliminar</button>`
  : ""; tr.innerHTML=`
  <td>${d.fecha||""}</td>
  <td>${d.hora||""}</td>
  <td>${d.cargo||""}</td>
  <td>${d.compania||""}</td>
  <td>${d.obac||""}</td>
  <td>${d.alarma||""}</td>
  <td>${d.tipo||""}</td>
  <td>${d.direccion||""}</td>
  <td>${accionesTd}</td>`; tbody.appendChild(tr); }); const res=$("#resumen"); if(res){ const r=resumen(filtrados,$("#filtroMes")?.value||""); res.innerHTML=`<span class="pill">Total (filtro): <b>${r.total}</b></span> <span class="pill">Total del mes seleccionado: <b>${r.totalMes}</b></span>`; } updateUiPermissions(); }

// GRÃFICOS
function themeChartOptions(){ const cs=getComputedStyle(document.documentElement); const grid=cs.getPropertyValue('--chart-grid').trim(); const ticks=cs.getPropertyValue('--chart-ticks').trim(); const legend=cs.getPropertyValue('--chart-legend').trim(); const legendLabels={color:legend,boxWidth:10,boxHeight:10,padding:8,font:{size:10}}; const tickStyle={color:ticks,font:{size:10}}; return { baseLegendBottom:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:legendLabels}}}, baseXY:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:tickStyle,grid:{color:grid}},y:{ticks:{...tickStyle,precision:0},grid:{color:grid},beginAtZero:true}}} } }
function agruparPor(arr,sel){ const m=new Map(); arr.forEach(x=>{ const k=sel(x); if(!k) return; m.set(k,(m.get(k)||0)+1); }); return { etiquetas:[...m.keys()], valores:[...m.values()] } }
const PALETA=["#ef4444","#f97316","#eab308","#22c55e","#06b6d4","#3b82f6","#8b5cf6","#ec4899","#14b8a6","#84cc16","#f59e0b","#fb7185","#38bdf8","#a78bfa","#10b981","#f472b6","#93c5fd","#fde047","#34d399","#c084fc","#60a5fa","#fda4af","#4ade80","#facc15"];
function paletaN(n){ const out=[]; for(let i=0;i<n;i++) out.push(PALETA[i%PALETA.length]); return out; }
function actualizarGraficos(){ const datos=aplicaFiltros(ordenarDesc(cargar())); const t=themeChartOptions();
  // CompaÃ±Ã­a
  const gC=agruparPor(datos,d=>d.compania); if(chartCompania) chartCompania.destroy(); chartCompania=new Chart(document.getElementById("grafCompania"),{type:"doughnut",data:{labels:gC.etiquetas,datasets:[{data:gC.valores,backgroundColor:paletaN(gC.valores.length),borderWidth:0,hoverOffset:3}]},options:{...t.baseLegendBottom,cutout:"55%"}});
  // Alarma
  const gA=agruparPor(datos,d=>d.alarma); if(chartAlarma) chartAlarma.destroy(); chartAlarma=new Chart(document.getElementById("grafAlarma"),{type:"doughnut",data:{labels:gA.etiquetas,datasets:[{data:gA.valores,backgroundColor:["#ef4444","#f97316","#eab308"],borderWidth:0,hoverOffset:3}]},options:{...t.baseLegendBottom,cutout:"55%"}});
  // Cargo
  const gCargo=agruparPor(datos,d=>d.cargo); if(chartCargo) chartCargo.destroy(); chartCargo=new Chart(document.getElementById("grafCargo"),{type:"doughnut",data:{labels:gCargo.etiquetas,datasets:[{data:gCargo.valores,backgroundColor:paletaN(gCargo.valores.length),borderWidth:0,hoverOffset:3}]},options:{...t.baseLegendBottom,cutout:"55%"}});
  // Tipo
  const gT=agruparPor(datos,d=>d.tipo); if(chartTipo) chartTipo.destroy(); chartTipo=new Chart(document.getElementById("grafTipo"),{type:"doughnut",data:{labels:gT.etiquetas,datasets:[{data:gT.valores,backgroundColor:["#22c55e","#06b6d4"],borderWidth:0,hoverOffset:3}]},options:{...t.baseLegendBottom,cutout:"55%"}});
  // Mes
  const gM=agruparPor(datos,d=>(d.fecha||"").slice(0,7)); const pares=gM.etiquetas.map((k,i)=>[k,gM.valores[i]]).sort((a,b)=>a[0].localeCompare(b[0])); if(chartMes) chartMes.destroy(); chartMes=new Chart(document.getElementById("grafMes"),{type:"line",data:{labels:pares.map(p=>p[0]),datasets:[{label:"Alarmas por Mes",data:pares.map(p=>p[1]),borderColor:"#ef4444",backgroundColor:"rgba(239,68,68,.18)",pointRadius:2,tension:.2,fill:true}]},options:t.baseXY});
  // OBAC
  const gO=agruparPor(datos,d=>d.obac); if(chartObac) chartObac.destroy(); chartObac=new Chart(document.getElementById("grafObac"),{type:"doughnut",data:{labels:gO.etiquetas,datasets:[{data:gO.valores,backgroundColor:paletaN(gO.valores.length),borderWidth:0,hoverOffset:3}]},options:{...t.baseLegendBottom,cutout:"55%"}});
}

// CRUD + VALIDACIONES
function validar(){ const fecha=$("#fecha")?.value; const hora=$("#hora")?.value; const cargo=$("#cargo")?.value; const compania=$("#compania")?.value; const obac=normaliza($("#obac")?.value); const alarma=$("#alarma")?.value; const tipo=$("#tipo")?.value; const direccion=normaliza($("#direccion")?.value); if(!fecha||!hora||!cargo||!compania||!obac||!alarma||!tipo) return null; return {fecha,hora,cargo,compania,obac,alarma,tipo,direccion}; }
async function guardarRegistro(){ if(!isWriter){alert("Solo usuarios autorizados pueden registrar.");return} const reg=validar(); if(!reg){alert("Completa todos los campos obligatorios.");return} const arr=cargar(); const newReg={id:String(Date.now())+Math.random().toString(16).slice(2),...reg}; arr.push(newReg); guardar(arr); try{await saveToFirestore(newReg)}catch(e){console.error(e);alert("No se pudo guardar en la nube.")} ["fecha","hora","obac","direccion"].forEach(id=>{const el=document.getElementById(id); if(el) el.value=""}); if($("#cargo")) $("#cargo").value="Comandante 1"; if($("#compania")) $("#compania").value="1Â° CompaÃ±Ã­a"; if($("#alarma")) $("#alarma").value="PRIMERA ALARMA"; if($("#tipo")) $("#tipo").value="Estructural"; renderTabla(); actualizarGraficos(); }
async function eliminar(id){ if(!isWriter){alert("Solo usuarios autorizados pueden eliminar.");return} if(!confirm("Â¿Eliminar este registro?")) return; const arr=cargar().filter(x=>x.id!==id); guardar(arr); try{await deleteFromFirestore(id)}catch(e){console.error(e);alert("No se pudo eliminar en la nube.")} renderTabla(); actualizarGraficos(); }
function abrirEditar(id){ if(!isWriter){ alert("Solo usuarios autorizados pueden editar."); return; } const r=cargar().find(x=>x.id===id); if(!r) return; editId=id; $("#e_fecha").value=r.fecha||""; $("#e_hora").value=r.hora||""; $("#e_cargo").value=r.cargo||"Comandante 1"; $("#e_compania").value=r.compania||"1Â° CompaÃ±Ã­a"; $("#e_obac").value=r.obac||""; $("#e_alarma").value=r.alarma||"PRIMERA ALARMA"; $("#e_tipo").value=r.tipo||"Estructural"; $("#e_direccion").value=r.direccion||""; $("#dlgEditar").showModal(); }
document.getElementById("dlgEditar").addEventListener("close",()=>{editId=null});
document.querySelector("#dlgEditar form").addEventListener("submit",async ev=>{ ev.preventDefault(); if(!isWriter){ alert("Solo usuarios autorizados pueden editar."); return; } const arr=cargar(); const i=arr.findIndex(x=>x.id===editId); if(i>=0){ arr[i]={...arr[i], fecha:$("#e_fecha").value, hora:$("#e_hora").value, cargo:$("#e_cargo").value, compania:$("#e_compania").value, obac:normaliza($("#e_obac").value), alarma:$("#e_alarma").value, tipo:$("#e_tipo").value, direccion:normaliza($("#e_direccion").value)}; guardar(arr); try{await saveToFirestore(arr[i])}catch(e){console.error(e);alert("No se pudo guardar cambios en la nube.")} } $("#dlgEditar").close(); renderTabla(); actualizarGraficos(); });

// Exportar / Importar
function exportarCSV(){ const arr=aplicaFiltros(ordenarDesc(cargar())); let csv="Fecha,Hora,Cargo,CompaÃ±Ã­a,OBAC,Alarma,Tipo,DirecciÃ³n\n"; arr.forEach(d=>{ const dir=(d.direccion||"").replace(/\"/g,'\"'); csv+=`${d.fecha},${d.hora},${d.cargo},${d.compania},${d.obac},${d.alarma},${d.tipo},"${dir}"\n`; }); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="alarmas_2026.csv"; a.click(); }
function exportarJSON(){ const arr=cargar(); const blob=new Blob([JSON.stringify(arr,null,2)],{type:"application/json;charset=utf-8;"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="alarmas_2026_backup.json"; a.click(); }
function importarJSON(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const imported=JSON.parse(reader.result); if(!Array.isArray(imported)) throw new Error("Formato invÃ¡lido."); const norm=imported.map(d=>({ id:d.id||String(Date.now())+Math.random().toString(16).slice(2), fecha:d.fecha, hora:d.hora, cargo:d.cargo||"", compania:d.compania||"", obac:d.obac, alarma:d.alarma, tipo:d.tipo, direccion:d.direccion||"" })); const actual=cargar(); guardar([...actual,...norm]); renderTabla(); actualizarGraficos(); alert("ImportaciÃ³n completada."); }catch(e){ alert("No se pudo importar: "+e.message); } }; reader.readAsText(file,"utf-8"); }

// GeolocalizaciÃ³n
async function usarUbicacion(){ if(!navigator.geolocation){alert("GeolocalizaciÃ³n no soportada.");return} try{ const pos=await new Promise((res,rej)=>{ navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000}); }); const {latitude:lat,longitude:lon}=pos.coords; const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=1`; let direccion=`Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`; try{ const resp=await fetch(url,{headers:{"Accept-Language":"es-CL,es;q=0.9"}}); if(resp.ok){ const data=await resp.json(); if(data&&data.display_name) direccion=data.display_name; } }catch(_){ } const input=document.getElementById("direccion"); if(input){ input.value=direccion; input.focus(); } }catch(err){ alert("No se pudo obtener ubicaciÃ³n. Revisa permisos."); } }

// Firestore helpers
async function saveToFirestore(reg){ await db.collection(COL).doc(reg.id).set(reg,{merge:true}); }
async function deleteFromFirestore(id){ await db.collection(COL).doc(id).delete(); }

// Auth + Permisos
const ADMIN_EMAILS=new Set([ "alarmas@toxicos.cl" ]);
let currentUser=null; window.isWriter=false;
function updateUiPermissions(){ const cardRegistrar=document.getElementById('cardRegistrar'); if(cardRegistrar) cardRegistrar.style.display=window.isWriter?'':'none'; document.querySelectorAll('button').forEach(b=>{ const t=(b.textContent||'').toLowerCase(); if(t.includes('editar')||t.includes('eliminar')){ b.disabled=!window.isWriter; b.style.opacity=window.isWriter?1:.6; b.title=window.isWriter?"":"Solo usuarios autorizados"; } }); const saveBtn=document.getElementById('btnGuardar'); if(saveBtn) saveBtn.disabled=!window.isWriter; const delAll=document.getElementById('btnBorrarTodo'); if(delAll) delAll.disabled=!window.isWriter; }
const dlgLogin=document.getElementById('dlgLogin');
document.getElementById('btnLogin')?.addEventListener('click',()=>{ if(dlgLogin){ document.getElementById('login_email').value=''; document.getElementById('login_pass').value=''; dlgLogin.showModal(); }});
document.getElementById('formLogin')?.addEventListener('submit', async ev=>{ ev.preventDefault(); const email=document.getElementById('login_email').value.trim(); const pass=document.getElementById('login_pass').value; try{ await auth.signInWithEmailAndPassword(email,pass); dlgLogin.close(); }catch(e){ alert("Error al iniciar sesiÃ³n: "+e.message); } });
document.getElementById('btnLogout')?.addEventListener('click', async ()=>{ await auth.signOut(); });
auth.onAuthStateChanged(user=>{ const email=(user&&user.email?user.email.trim().toLowerCase():""); currentUser=user; window.isWriter=!!(email&&ADMIN_EMAILS.has(email)); const loginBtn=document.getElementById('btnLogin'); const logoutBtn=document.getElementById('btnLogout'); if(user){ if(loginBtn) loginBtn.style.display='none'; if(logoutBtn){ logoutBtn.style.display='inline-block'; logoutBtn.textContent=`Salir (${email})`; } }else{ if(loginBtn) loginBtn.style.display='inline-block'; if(logoutBtn) logoutBtn.style.display='none'; } updateUiPermissions(); renderTabla(); });

// Tiempo real + carga inicial
async function cargarNubeUnaVez(){ try{ const snap=await db.collection(COL).get(); const cloud=[]; snap.forEach(doc=>cloud.push(doc.data())); localStorage.setItem(KEY, JSON.stringify(ordenarDesc(cloud))); }catch(e){ console.warn('GET Firestore error',e); } }
let unsubRealtime=null; function subscribeRealtime(){ if(unsubRealtime) unsubRealtime(); unsubRealtime = db.collection(COL).onSnapshot(snap=>{ const cloud=[]; snap.forEach(doc=>cloud.push(doc.data())); localStorage.setItem(KEY, JSON.stringify(ordenarDesc(cloud))); renderTabla(); actualizarGraficos(); }, err=>console.error('onSnapshot error',err)); }

// Eventos
document.getElementById("btnGuardar")?.addEventListener("click",guardarRegistro);
document.getElementById("btnExportarCSV")?.addEventListener("click",exportarCSV);
document.getElementById("btnExportarJSON")?.addEventListener("click",exportarJSON);
document.getElementById("btnImportarJSON")?.addEventListener("click",()=>document.getElementById("importJSON").click());
document.getElementById("importJSON")?.addEventListener("change",e=>{ const f=e.target.files[0]; if(f) importarJSON(f); });
document.getElementById("btnBorrarTodo")?.addEventListener("click",()=>{ if(!window.isWriter){alert("Solo usuarios autorizados.");return} if(!confirm("Esto borrarÃ¡ los registros locales en este navegador. Â¿Continuar?")) return; localStorage.removeItem(KEY); renderTabla(); actualizarGraficos(); });
document.getElementById("btnGeo")?.addEventListener("click",usarUbicacion);
document.addEventListener("change",e=>{ if(e.target&&e.target.id==="filtroMes"){ renderTabla(); actualizarGraficos(); }});
document.addEventListener("input",e=>{ if(e.target&&e.target.id==="buscar"){ renderTabla(); actualizarGraficos(); }});
document.getElementById("btnSyncNube")?.addEventListener("click", async ()=>{ if(!window.isWriter){alert("Solo usuarios autorizados.");return} const arr=cargar(); try{ await Promise.all(arr.map(r=>saveToFirestore(r))); alert("SincronizaciÃ³n completa."); }catch(e){ alert("No se pudo sincronizar: "+e.message); } });

// Init
cargarNubeUnaVez().then(()=>{ renderTabla(); actualizarGraficos(); subscribeRealtime(); });

/*************** Utilidad: nombre de mes en espaÃ±ol ***************/
function nombreMesEs(aaaaMM){
  const MESES=[ 'Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre' ];
  const m=parseInt((aaaaMM||'').slice(5,7),10); return (m>=1&&m<=12)?MESES[m-1]:aaaaMM;
}

/*************** Totales por mes (con o sin filtros) ***************/
function construirLineasTotalesPorMes(usarFiltros){
  const base=ordenarDesc(cargar());
  const datos=usarFiltros?aplicaFiltros(base):base;
  const mesSel=(document.getElementById('filtroMes')?.value||'').trim();
  const mapMes=new Map();
  for(const d of datos){ const k=(d.fecha||'').slice(0,7); if(!k) continue; mapMes.set(k,(mapMes.get(k)||0)+1); }
  if(mesSel && mapMes.size){ const n=mapMes.get(mesSel)||0; return n>0?[`${nombreMesEs(mesSel)} = ${n}`]:[]; }
  const orden=[...mapMes.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
  return orden.map(([k,n])=>`${nombreMesEs(k)} = ${n}`);
}

/*************** RANKING CompaÃ±Ã­a - OBAC con totales de mes ***************/
function construirRankingCompaniaObac(usarFiltros){
  const base=ordenarDesc(cargar());
  const datos=usarFiltros?aplicaFiltros(base):base;
  const mapa=new Map();
  for(const d of datos){ const compania=(d.compania||'').trim(); const obac=(d.obac||'').trim(); if(!compania||!obac) continue; const clave=`${compania} - ${obac}`; mapa.set(clave,(mapa.get(clave)||0)+1); }
  const orden=[...mapa.entries()].sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],'es'));
  const titulo=`Contador Alarmas 2026 ğŸ”¥`;
  const lineasRanking=orden.map(([k,n])=>`${k} = ${n}`);
  const lineasMes=construirLineasTotalesPorMes(usarFiltros);
  return lineasMes.length ? [titulo, ...lineasRanking, ...lineasMes].join('\n') : [titulo, ...lineasRanking].join('\n');
}

/*************** BotÃ³n: copiar ranking ***************/
(function initRankingCompObac(){
  const btn=document.getElementById('btnRankingCompObac');
  const chk=document.getElementById('rk2_usarFiltros');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    const usar=!!(chk && chk.checked);
    const texto=construirRankingCompaniaObac(usar);
    try{ await navigator.clipboard.writeText(texto); alert('ğŸ“‹ Ranking copiado al portapapeles.'); }
    catch(_){ const ta=document.createElement('textarea'); ta.value=texto; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('ğŸ“‹ Ranking copiado (mÃ©todo alternativo).'); }
  });
})();
</script>
</body>
</html>