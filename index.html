<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Contador de Alarmas 2026</title>

<!-- Chart.js (CDN oficial) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ==================== THEMING ==================== */
  :root {
    /* Tema CLARO */
    --bg: #f4f5f7;
    --card: #ffffff;
    --text: #111827;
    --muted: #4b5563;
    --border: #e5e7eb;
    --primary: #ef4444;
    --primary-2: #dc2626;
    --secondary: #334155;
    --warn: #8b5e34;
    --gray: #6b7280;
    --chip: #f3f4f6;
    --chart-grid: rgba(0, 0, 0, 0.08);
    --chart-ticks: #374151;
    --chart-legend: #111827;
  }
  :root[data-theme="dark"] {
    /* Tema OSCURO (por defecto si no hay guardado) */
    --bg: #0f1216;
    --card: #171a1f;
    --text: #e5e7eb;
    --muted: #9aa4b2;
    --border: #242a32;
    --primary: #ef4444;
    --primary-2: #dc2626;
    --secondary: #334155;
    --warn: #8b5e34;
    --gray: #6b7280;
    --chip: #1f2733;
    --chart-grid: rgba(148,163,184,0.15);
    --chart-ticks: #cbd5e1;
    --chart-legend: #e5e7eb;
  }

  * { box-sizing: border-box; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 0; padding: 12px; background: var(--bg); color: var(--text);
  }
  .container { max-width: 1100px; margin: 0 auto; }
  .card {
    background: var(--card); border: 1px solid var(--border);
    padding: 12px; border-radius: 10px; margin-bottom: 12px;
    box-shadow: 0 1px 8px rgba(0,0,0,.15);
  }
  h1,h2,h3 { margin: 0 0 10px 0; font-weight: 700; }
  .muted { color: var(--muted); font-size: 13px; }
  .pill {
    display:inline-block; padding:3px 8px; border-radius:999px;
    background: var(--chip); color: var(--muted); margin-right:6px; font-size:12px;
    border: 1px solid var(--border);
  }

  /* Switch de tema */
  .header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .theme-toggle { display:flex; align-items:center; gap:8px; }
  .switch { position: relative; display: inline-block; width: 48px; height: 26px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; cursor: pointer; inset: 0; border: 1px solid var(--border);
    background-color: #64748b; transition: .2s; border-radius: 999px;
  }
  .slider:before {
    position: absolute; content: ""; height: 20px; width: 20px; left: 3px; top: 2px;
    background-color: white; transition: .2s; border-radius: 50%;
  }
  input:checked + .slider { background-color: #ef4444; }
  input:checked + .slider:before { transform: translateX(22px); }
  .theme-label { font-size: 13px; color: var(--muted); }

  /* Details/summary (secciones plegables) */
  details { border-radius: 8px; }
  summary {
    list-style: none; cursor: pointer; font-weight: 700;
    padding: 8px 10px; border-radius: 8px; display:flex; align-items:center; gap:8px;
    color: var(--text);
  }
  summary::marker { display:none; }
  summary .badge {
    background: rgba(239, 68, 68, .15);
    color: var(--primary);
    padding:2px 8px; border-radius:12px; font-size:12px; border: 1px solid var(--border);
  }

  .row { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:8px; }
  label { display:block; margin:4px 0 3px; font-weight:600; font-size:13px; color: var(--muted); }
  input, select {
    width:100%; padding:8px; border:1px solid var(--border); border-radius:8px; font-size:14px;
    background:#0b0e12; color: var(--text);
  }
  :root[data-theme="light"] input, :root[data-theme="light"] select { background:#ffffff; color: var(--text); }
  input::placeholder { color:#7a8699; }

  /* Botones */
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button {
    padding:8px 10px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-size:14px; cursor:pointer;
  }
  button:hover { background: var(--primary-2); }
  button.secondary { background: var(--secondary); }
  button.secondary:hover { background: #1f2a37; }
  button.warn { background: var(--warn); }
  button.warn:hover { background: #734a2a; }
  button.gray { background: var(--gray); }
  button.gray:hover { background: #4b5563; }

  /* Tabla */
  table { width:100%; border-collapse: collapse; margin-top:8px; font-size:13px; }
  th, td { border:1px solid var(--border); padding:6px; text-align:center; }
  th { background:#0b0f14; color: var(--muted); }
  :root[data-theme="light"] th { background:#f8fafc; }

  /* Toolbar y filtros */
  .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .toolbar .grow { flex:1; }

  /* Gr√°ficos compactos (proporci√≥n correcta) */
  .charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
  .charts .chart-card {
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #0b0f14;
    height: 180px; /* altura fija del contenedor */
  }
  :root[data-theme="light"] .charts .chart-card { background:#ffffff; }
  .charts .chart-card canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

  /* Direcci√≥n con bot√≥n al lado */
  .direccion-group { display:flex; gap:6px; align-items:flex-end; }
  .direccion-group > div { flex: 1; }
</style>
</head>
<body>
<div class="container">

  <!-- Encabezado con switch -->
  <div class="card">
    <div class="header-row">
      <div>
        <h1>Contador de Alarmas 2026 üî•</h1>
        <div class="muted">Registrar (plegado) ‚Üí Dashboard visible ‚Üí Registros (plegado). Tema claro/oscuro con switch.</div>
      </div>

      <div class="theme-toggle">
        <span class="theme-label">‚òÄÔ∏è</span>
        <label class="switch" aria-label="Cambiar tema claro/oscuro">
          <input id="themeSwitch" type="checkbox" />
          <span class="slider"></span>
        </label>
        <span class="theme-label">üåô</span>
      </div>
    </div>
  </div>

  <!-- 1) REGISTRAR (PLEGADO por defecto) -->
  <div class="card">
    <details>
      <summary>‚ûï Registrar alarma <span class="badge">compacto</span></summary>
      <div class="row">
        <div>
          <label for="fecha">Fecha del Incendio</label>
          <input type="date" id="fecha" required />
        </div>
        <div>
          <label for="hora">Hora del Incendio</label>
          <input type="time" id="hora" required />
        </div>
        <div>
          <label for="cargo">Cargo</label>
          <select id="cargo" required>
            <option value="Comandante 1">Comandante 1</option>
            <option value="Comandante 2">Comandante 2</option>
            <option value="Comandante 3">Comandante 3</option>
            <option value="Comandante 4">Comandante 4</option>
            <option value="Capit√°n">Capit√°n</option>
            <option value="Teniente 1¬∞">Teniente 1¬∞</option>
            <option value="Teniente 2¬∞">Teniente 2¬∞</option>
            <option value="Teniente 3¬∞">Teniente 3¬∞</option>
            <option value="Inspector">Inspector</option>
            <option value="Voluntario">Voluntario</option>
            <option value="Central">Central</option>
            <option value="Cuartelero">Cuartelero</option>
            <option value="Canje">Canje</option>
          </select>
        </div>
        <div>
          <label for="obac">OBAC</label>
          <input type="text" id="obac" placeholder="Ej: OBAC 1" required />
        </div>
        <div>
          <label for="alarma">Alarma de Incendio</label>
          <select id="alarma" required>
            <option value="PRIMERA ALARMA">PRIMERA ALARMA</option>
            <option value="SEGUNDA ALARMA">SEGUNDA ALARMA</option>
            <option value="TERCERA ALARMA">TERCERA ALARMA</option>
          </select>
        </div>
        <div>
          <label for="tipo">Tipo de Incendio</label>
          <select id="tipo" required>
            <option value="Estructural">Estructural</option>
            <option value="Forestal">Forestal</option>
          </select>
        </div>

        <!-- Direcci√≥n + bot√≥n de ubicaci√≥n -->
        <div class="direccion-group" style="grid-column: 1 / -1;">
          <div>
            <label for="direccion">Direcci√≥n (opcional)</label>
            <input type="text" id="direccion" placeholder="Ej: Av. Siempre Viva 742, Comuna" />
          </div>
          <div style="width:fit-content;">
            <button type="button" id="btnGeo" class="secondary" title="Usar ubicaci√≥n actual">üìç Usar ubicaci√≥n</button>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="btnGuardar">üìå Guardar</button>
        <button id="btnExportarCSV" class="secondary">üì• CSV</button>
        <button id="btnExportarJSON" class="secondary">üß© Exportar JSON</button>
        <label class="secondary" style="display:inline-flex; align-items:center; gap:8px; padding:0;">
          <input id="importJSON" type="file" accept="application/json" style="display:none;">
          <button type="button" class="secondary" id="btnImportarJSON">üì§ Importar JSON</button>
        </label>
        <button id="btnBorrarTodo" class="warn">üóëÔ∏è Borrar todo</button>
      </div>
      <div class="muted" style="margin-top:6px">
        * Los datos se guardan localmente (LocalStorage). Para sincronizar entre equipos podemos conectar Google Sheets o Firebase si te sirve.
      </div>
    </details>
  </div>

  <!-- 2) DASHBOARD (siempre visible) -->
  <div class="card">
    <h2>Dashboard</h2>
    <div class="charts">
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Alarma</h3>
        <canvas id="grafAlarma"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Tipo</h3>
        <canvas id="grafTipo"></canvas>
      </div>
      <div class="chart-card">
        <h3 class="muted" style="margin-bottom:6px;">Por Mes (AAAA‚ÄëMM)</h3>
        <canvas id="grafMes"></canvas>
      </div>
    </div>
  </div>

  <!-- 3) REGISTROS (PLEGABLE) -->
  <div class="card">
    <details>
      <summary>üìÑ Registros <span class="badge">tabla</span></summary>

      <div class="toolbar" style="margin-top:8px;">
        <h2 style="margin-right:auto;">&nbsp;</h2>
        <div>
          <label class="muted" for="filtroMes">Mes (AAAA‚ÄëMM)</label>
          <input type="month" id="filtroMes" />
        </div>
        <div class="grow">
          <label class="muted" for="buscar">Buscar (Cargo / OBAC / Alarma / Tipo / Direcci√≥n)</label>
          <input type="text" id="buscar" placeholder="Buscar..." />
        </div>
      </div>

      <div id="resumen" class="muted" style="margin-top:6px"></div>

      <table id="tabla">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Cargo</th>
            <th>OBAC</th>
            <th>Alarma</th>
            <th>Tipo</th>
            <th>Direcci√≥n</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </details>
  </div>

  <!-- Di√°logo para editar -->
  <dialog id="dlgEditar">
    <form method="dialog">
      <h3>Editar registro</h3>
      <div class="row">
        <div>
          <label for="e_fecha">Fecha</label>
          <input type="date" id="e_fecha" required />
        </div>
        <div>
          <label for="e_hora">Hora</label>
          <input type="time" id="e_hora" required />
        </div>
        <div>
          <label for="e_cargo">Cargo</label>
          <select id="e_cargo" required>
            <option value="Comandante 1">Comandante 1</option>
            <option value="Comandante 2">Comandante 2</option>
            <option value="Comandante 3">Comandante 3</option>
            <option value="Comandante 4">Comandante 4</option>
            <option value="Capit√°n">Capit√°n</option>
            <option value="Teniente 1¬∞">Teniente 1¬∞</option>
            <option value="Teniente 2¬∞">Teniente 2¬∞</option>
            <option value="Teniente 3¬∞">Teniente 3¬∞</option>
            <option value="Inspector">Inspector</option>
            <option value="Voluntario">Voluntario</option>
            <option value="Central">Central</option>
            <option value="Cuartelero">Cuartelero</option>
            <option value="Canje">Canje</option>
          </select>
        </div>
        <div>
          <label for="e_obac">OBAC</label>
          <input type="text" id="e_obac" required />
        </div>
        <div>
          <label for="e_alarma">Alarma</label>
          <select id="e_alarma" required>
            <option value="PRIMERA ALARMA">PRIMERA ALARMA</option>
            <option value="SEGUNDA ALARMA">SEGUNDA ALARMA</option>
            <option value="TERCERA ALARMA">TERCERA ALARMA</option>
          </select>
        </div>
        <div>
          <label for="e_tipo">Tipo</label>
          <select id="e_tipo" required>
            <option value="Estructural">Estructural</option>
            <option value="Forestal">Forestal</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <label for="e_direccion">Direcci√≥n</label>
          <input type="text" id="e_direccion" />
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button type="submit">üíæ Guardar</button>
        <button type="button" class="gray" onclick="document.getElementById('dlgEditar').close()">Cancelar</button>
      </div>
    </form>
  </dialog>

</div>

<script>
/* ==================== Almacenamiento ==================== */
const KEY = "alarmas_2026";
const KEY_THEME = "alarmas_theme";

/** Carga registros desde LocalStorage; asegura compatibilidad con campos nuevos. */
function cargar(){
  let arr;
  try { arr = JSON.parse(localStorage.getItem(KEY)) || []; } catch { arr = []; }
  let changed = false;
  arr.forEach(r => {
    if (!r.id)        { r.id = String(Date.now()) + Math.random().toString(16).slice(2); changed = true; }
    if (r.cargo === undefined)     { r.cargo = ""; changed = true; }
    if (r.direccion === undefined) { r.direccion = ""; changed = true; }
  });
  if (changed) localStorage.setItem(KEY, JSON.stringify(arr));
  return arr;
}
function guardar(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }

/* ==================== Tema (switch) ==================== */
function getSystemPrefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
function getSavedTheme(){ return localStorage.getItem(KEY_THEME); }
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  const sw = document.getElementById('themeSwitch');
  if (sw) sw.checked = (theme === 'dark');
  actualizarGraficos(); // re-render para aplicar colores
}
function initTheme(){
  const saved = getSavedTheme();
  let theme = saved || (getSystemPrefersDark() ? 'dark' : 'light');
  if (!saved) theme = 'dark'; // oscuro por defecto
  applyTheme(theme);
  const sw = document.getElementById('themeSwitch');
  if (sw) {
    sw.checked = (theme === 'dark');
    sw.addEventListener('change', () => {
      const next = sw.checked ? 'dark' : 'light';
      localStorage.setItem(KEY_THEME, next);
      applyTheme(next);
    });
  }
}

/* ==================== Estado UI ==================== */
let chartAlarma, chartTipo, chartMes;
let editId = null;
const $ = (s) => document.querySelector(s);

function normaliza(s){ return (s||"").trim(); }
function ordenarDesc(arr){
  return [...arr].sort((a,b)=>{
    const A = (a.fecha||"") + " " + (a.hora||"00:00");
    const B = (b.fecha||"") + " " + (b.hora||"00:00");
    return B.localeCompare(A);
  });
}
function aplicaFiltros(arr){
  const mes = $("#filtroMes")?.value || ""; // AAAA-MM
  const q = ($("#buscar")?.value || "").toLowerCase().trim();
  return arr.filter(d=>{
    const okMes = !mes || (d.fecha||"").startsWith(mes);
    const text = `${d.cargo} ${d.obac} ${d.alarma} ${d.tipo} ${d.direccion}`.toLowerCase();
    const okQ = !q || text.includes(q);
    return okMes && okQ;
  });
}
function resumen(arr, mesSel){
  const total = arr.length;
  const totalMes = mesSel ? arr.filter(d => (d.fecha||"").startsWith(mesSel)).length : total;
  return { total, totalMes };
}

/* ==================== Render Tabla & Resumen ==================== */
function renderTabla(){
  const datos = ordenarDesc(cargar());
  const filtrados = aplicaFiltros(datos);
  const tbody = document.querySelector("#tabla tbody");
  if (!tbody) return; // por si la secci√≥n est√° plegada y a√∫n no se mont√≥
  tbody.innerHTML = "";
  filtrados.forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.fecha||""}</td>
      <td>${d.hora||""}</td>
      <td>${d.cargo||""}</td>
      <td>${d.obac||""}</td>
      <td>${d.alarma||""}</td>
      <td>${d.tipo||""}</td>
      <td>${d.direccion||""}</td>
      <td>
        <button class="gray" onclick="abrirEditar('${d.id}')">Editar</button>
        <button class="warn" onclick="eliminar('${d.id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  const res = document.getElementById("resumen");
  if (res) {
    const r = resumen(filtrados, document.getElementById("filtroMes")?.value || "");
    res.innerHTML =
      `<span class="pill">Total (filtro): <b>${r.total}</b></span>
       <span class="pill">Total del mes seleccionado: <b>${r.totalMes}</b></span>`;
  }
}

/* ==================== Gr√°ficos (colores seg√∫n tema + proporci√≥n correcta) ==================== */
function themeChartOptions(){
  const cs = getComputedStyle(document.documentElement);
  const grid   = cs.getPropertyValue('--chart-grid').trim();
  const ticks  = cs.getPropertyValue('--chart-ticks').trim();
  const legend = cs.getPropertyValue('--chart-legend').trim();

  const legendLabels = {
    color: legend,
    boxWidth: 10,
    boxHeight: 10,
    padding: 8,
    usePointStyle: false,
    font: { size: 10 }
  };
  const tickStyle = { color: ticks, font: { size: 10 } };

  return {
    baseLegendBottom: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: "bottom", labels: legendLabels } }
    },
    baseXY: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: tickStyle, grid: { color: grid } },
        y: { ticks: { ...tickStyle, precision: 0 }, grid: { color: grid }, beginAtZero: true }
      }
    }
  };
}

function agruparPor(arr, sel){
  const m = new Map();
  arr.forEach(x => { const k = sel(x); if (!k) return; m.set(k, (m.get(k)||0)+1); });
  const etiquetas = [...m.keys()];
  const valores = [...m.values()];
  return { etiquetas, valores };
}

function actualizarGraficos(){
  const datos = aplicaFiltros(ordenarDesc(cargar()));
  const t = themeChartOptions();

  // Por Alarma (DONUT) + sin borde
  const gA = agruparPor(datos, d => d.alarma);
  if (chartAlarma) chartAlarma.destroy();
  chartAlarma = new Chart(document.getElementById("grafAlarma"), {
    type: "doughnut",
    data: {
      labels: gA.etiquetas,
      datasets: [{
        data: gA.valores,
        backgroundColor: ["#ef4444","#f97316","#eab308"],
        borderWidth: 0,
        hoverOffset: 3
      }]
    },
    options: { ...t.baseLegendBottom, cutout: "55%" }
  });

  // Por Tipo (DONUT) + sin borde
  const gT = agruparPor(datos, d => d.tipo);
  if (chartTipo) chartTipo.destroy();
  chartTipo = new Chart(document.getElementById("grafTipo"), {
    type: "doughnut",
    data: {
      labels: gT.etiquetas,
      datasets: [{
        data: gT.valores,
        backgroundColor: ["#22c55e","#06b6d4"],
        borderWidth: 0,
        hoverOffset: 3
      }]
    },
    options: { ...t.baseLegendBottom, cutout: "55%" }
  });

  // Por Mes (L√çNEA)
  const gM = agruparPor(datos, d => (d.fecha||"").slice(0,7));
  const pares = gM.etiquetas.map((k,i)=>[k,gM.valores[i]]).sort((a,b)=>a[0].localeCompare(b[0]));
  if (chartMes) chartMes.destroy();
  chartMes = new Chart(document.getElementById("grafMes"), {
    type: "line",
    data: {
      labels: pares.map(p=>p[0]),
      datasets: [{
        label:"Alarmas por Mes",
        data: pares.map(p=>p[1]),
        borderColor:"#ef4444",
        backgroundColor:"rgba(239,68,68,.18)",
        pointRadius: 2,
        tension:.2,
        fill:true
      }]
    },
    options: t.baseXY
  });
}

/* ==================== CRUD ==================== */
function validar(){
  const fecha = document.getElementById("fecha").value;
  const hora  = document.getElementById("hora").value;
  const cargo = document.getElementById("cargo").value;
  const obac  = normaliza(document.getElementById("obac").value);
  const alarma= document.getElementById("alarma").value;
  const tipo  = document.getElementById("tipo").value;
  const direccion = normaliza(document.getElementById("direccion").value); // opcional
  if (!fecha || !hora || !cargo || !obac || !alarma || !tipo) return null;
  return { fecha, hora, cargo, obac, alarma, tipo, direccion };
}
function guardarRegistro(){
  const reg = validar();
  if (!reg) { alert("Completa todos los campos obligatorios."); return; }
  const arr = cargar();
  arr.push({ id: String(Date.now())+Math.random().toString(16).slice(2), ...reg });
  guardar(arr);
  ["fecha","hora","obac","direccion"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("cargo").value  = "Comandante 1";
  document.getElementById("alarma").value = "PRIMERA ALARMA";
  document.getElementById("tipo").value   = "Estructural";
  renderTabla(); actualizarGraficos();
}
function eliminar(id){
  if (!confirm("¬øEliminar este registro?")) return;
  const arr = cargar().filter(x => x.id !== id);
  guardar(arr);
  renderTabla(); actualizarGraficos();
}
function abrirEditar(id){
  const r = cargar().find(x => x.id === id);
  if (!r) return;
  editId = id;
  document.getElementById("e_fecha").value  = r.fecha || "";
  document.getElementById("e_hora").value   = r.hora  || "";
  document.getElementById("e_cargo").value  = r.cargo || "Comandante 1";
  document.getElementById("e_obac").value   = r.obac  || "";
  document.getElementById("e_alarma").value = r.alarma|| "PRIMERA ALARMA";
  document.getElementById("e_tipo").value   = r.tipo  || "Estructural";
  document.getElementById("e_direccion").value = r.direccion || "";
  document.getElementById("dlgEditar").showModal();
}
document.getElementById("dlgEditar").addEventListener("close", ()=>{ editId=null; });
document.querySelector("#dlgEditar form").addEventListener("submit",(ev)=>{
  ev.preventDefault();
  const arr = cargar();
  const i = arr.findIndex(x => x.id === editId);
  if (i >= 0){
    arr[i] = {
      ...arr[i],
      fecha: document.getElementById("e_fecha").value,
      hora:  document.getElementById("e_hora").value,
      cargo: document.getElementById("e_cargo").value,
      obac:  normaliza(document.getElementById("e_obac").value),
      alarma:document.getElementById("e_alarma").value,
      tipo:  document.getElementById("e_tipo").value,
      direccion: normaliza(document.getElementById("e_direccion").value)
    };
    guardar(arr);
  }
  document.getElementById("dlgEditar").close();
  renderTabla(); actualizarGraficos();
});

/* ==================== Exportar / Importar ==================== */
function exportarCSV(){
  const arr = aplicaFiltros(ordenarDesc(cargar()));
  let csv = "Fecha,Hora,Cargo,OBAC,Alarma,Tipo,Direcci√≥n\n";
  arr.forEach(d => {
    const dir = (d.direccion||"").replace(/\"/g, '\"');
    csv += `${d.fecha},${d.hora},${d.cargo},${d.obac},${d.alarma},${d.tipo},"${dir}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "alarmas_2026.csv";
  a.click();
}
function exportarJSON(){
  const arr = cargar();
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:"application/json;charset=utf-8;"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "alarmas_2026_backup.json";
  a.click();
}
function importarJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const imported = JSON.parse(reader.result);
      if (!Array.isArray(imported)) throw new Error("Formato inv√°lido.");
      const norm = imported.map(d => ({
        id: d.id || String(Date.now())+Math.random().toString(16).slice(2),
        fecha:d.fecha, hora:d.hora, cargo: d.cargo || "", obac:d.obac,
        alarma:d.alarma, tipo:d.tipo, direccion: d.direccion || ""
      }));
      const actual = cargar();
      guardar([...actual, ...norm]);
      renderTabla(); actualizarGraficos();
      alert("Importaci√≥n completada.");
    } catch(e){
      alert("No se pudo importar: " + e.message);
    }
  };
  reader.readAsText(file, "utf-8");
}

/* ==================== Ubicaci√≥n (rellenar Direcci√≥n) ==================== */
async function usarUbicacion(){
  if (!navigator.geolocation) {
    alert("Geolocalizaci√≥n no soportada por este navegador.");
    return;
  }
  try {
    const pos = await new Promise((res, rej) => {
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 });
    });
    const { latitude: lat, longitude: lon } = pos.coords;

    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&addressdetails=1`;
    let direccion = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;

    try {
      const resp = await fetch(url, { headers: { "Accept-Language": "es-CL,es;q=0.9" } });
      if (resp.ok) {
        const data = await resp.json();
        if (data && data.display_name) direccion = data.display_name;
      }
    } catch (_) { /* si falla, usamos Lat/Lon */ }

    const input = document.getElementById("direccion");
    input.value = direccion;
    input.focus();
  } catch (err) {
    alert("No se pudo obtener tu ubicaci√≥n. Revisa permisos de GPS/ubicaci√≥n.");
  }
}

/* ==================== Eventos ==================== */
document.getElementById("btnGuardar").addEventListener("click", guardarRegistro);
document.getElementById("btnExportarCSV").addEventListener("click", exportarCSV);
document.getElementById("btnExportarJSON").addEventListener("click", exportarJSON);
document.getElementById("btnImportarJSON").addEventListener("click", ()=> document.getElementById("importJSON").click());
document.getElementById("importJSON").addEventListener("change", (e)=> { const f = e.target.files[0]; if (f) importarJSON(f); });
document.getElementById("btnBorrarTodo").addEventListener("click", ()=>{
  if (!confirm("Esto borrar√° todos los registros guardados localmente en este navegador. ¬øContinuar?")) return;
  localStorage.removeItem(KEY); renderTabla(); actualizarGraficos();
});
document.getElementById("btnGeo").addEventListener("click", usarUbicacion);

/* Filtros (la secci√≥n puede estar plegada; por eso comprobamos existencia) */
document.addEventListener("change", (e)=>{
  if (e.target && (e.target.id === "filtroMes")) { renderTabla(); actualizarGraficos(); }
});
document.addEventListener("input", (e)=>{
  if (e.target && (e.target.id === "buscar")) { renderTabla(); actualizarGraficos(); }
});

/* ==================== Inicializaci√≥n ==================== */
initTheme();
renderTabla();
actualizarGraficos();
</script>
</body>
</html>
